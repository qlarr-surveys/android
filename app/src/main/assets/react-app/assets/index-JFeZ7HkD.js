import{r as c,j as e,B as X,s as oe}from"./index-BdaHkdQl.js";import{c as Y,a as d,o as ee,d as le,b as ce}from"./yup-DY16kGze.js";import{u as ae,F as se,o as de,I as P,R as p,a as me,A as ue,r as J}from"./Web-Xt-AHKsA.js";import{A as T,am as O,a3 as fe,T as f,an as he,v as pe,y as xe,w as _e,D as we,F as K,ao as Q,al as ge,I as q}from"./use-service-D09swmN7.js";import{u as Ne}from"./use-boolean-Bxf0TRXb.js";import{j as ve}from"./TextField-B66jFwFo.js";import{L as N}from"./LoadingButton-CeTIEj79.js";import{L as be}from"./Link-Iys5U15E.js";import{S as je}from"./index-sQ3HDfyg.js";import{I as D}from"./InputAdornment-CMc9n4GQ.js";import"./Checkbox-0qy6A3Vu.js";import"./SwitchBase-outpB1OY.js";import"./useFormControl-BousA45m.js";import"./Tabs-CXy611xA.js";import"./radioClasses-DNdhtY0L.js";import"./tableRowClasses-D2zlaSzG.js";import"./FormControlLabel-DrGXXvQK.js";const Ae="_verifyContainer_rwmnr_1",Se={verifyContainer:Ae};function Ee({t,open:x,email:v,resend:I,onClose:a}){const o=T("user"),[_,i]=c.useState(!1),b=Y().shape({pin:d().min(6,"".concat(t("email.code_characters"))).required("".concat(t("email.code_required")))}),j={pin:""},w=ae({mode:"onChange",resolver:ee(b),defaultValues:j}),{handleSubmit:A,setError:S,reset:R}=w,E=A(async k=>{i(!0),o.confirmEmail(k).then(()=>{i(!1),a(!0),R(j)}).catch(G=>{i(!1),S("pin",{type:"manual",message:t("processed_errors.".concat(G.name))})})});return e.jsx(ve,{open:x,"aria-labelledby":"email-verification-modal","aria-describedby":"email-verification-modal-description",children:e.jsx(X,{className:Se.verifyContainer,children:e.jsxs(O,{sx:{textAlign:"center"},children:[e.jsx(fe,{alt:"email inbox",src:"/ic_email_inbox.svg",sx:{mb:5,width:96,height:96,mx:"auto"}}),e.jsx(f,{variant:"h3",children:t("email.check")}),e.jsxs(f,{variant:"body2",sx:{mt:2,mb:5,color:"text.secondary"},children:[t("email.confirmation_code1")," ",v," ",t("email.confirmation_code2")]}),e.jsxs(se,{methods:w,onSubmit:E,children:[e.jsx(de,{name:"pin"}),e.jsx(N,{fullWidth:!0,size:"large",color:"inherit",type:"submit",variant:"contained",loading:_,sx:{mt:3},children:t("email.verify")})]}),e.jsxs(f,{variant:"body2",align:"center",sx:{mt:3},children:[t("email.dont_have_code"),e.jsxs(be,{variant:"subtitle2",onClick:()=>I(),underline:"none",sx:{cursor:"pointer"},children:[" ",t("email.resend_code")]})]}),e.jsxs(he,{onClick:()=>a(!1),color:"inherit",sx:{mt:3,mx:"auto",alignItems:"center",display:"inline-flex"},children:[e.jsx(P,{icon:"carbon:chevron-left",width:16,sx:{mr:1}}),t("action_btn.close")]})]})})})}const n={NONE:"",CHANGE_EMAIL:"CHANGE_EMAIL",CHANGE_PASSWORD:"CHANGE_PASSWORD"};function Me(){const t=T("auth"),x=T("user"),v=oe(),I=pe(s=>s.editState.loading),{t:a}=xe("manage"),o=Ne(),_=_e.getUser().id,[i,b]=c.useState({}),[j,w]=c.useState(!1),[A,S]=c.useState(!1),[R,E]=c.useState(!1),[k,G]=c.useState(!1),[l,C]=c.useState(n.NONE),z=we(),F=()=>{E(!1)};le(d,"noWhitespace",function(s){return this.test("no-whitespace",s,function(r){const{path:h,createError:y}=this;return r!=null&&r.trim()?!0:y({path:h,message:s})})});const W=s=>{let r={firstName:d().required(a("firstname_required")).noWhitespace(a("error.invalid_first_name")).max(50,a("error.first_name_too_long")).matches(/^[A-Za-z]+$/,a("error.invalid_first_name")),lastName:d().required(a("lastname_required")).noWhitespace(a("error.invalid_last_name")).max(50,a("error.last_name_too_long")).matches(/^[A-Za-z]+$/,a("error.invalid_last_name"))};return s===n.CHANGE_EMAIL&&(r={...r,currentPassword:d().required(a("password_required")),email:d().required(a("email_required")).matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/i,a("error.invalid_email"))}),s===n.CHANGE_PASSWORD&&(r={...r,currentPassword:d().required(a("password_required")).matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/,a("error.invalid_password")),newPassword:d().required(a("password_required")),confirmNewPassword:d().required(a("password_required")).oneOf([ce("newPassword"),null],a("error.password_should_match"))}),Y().shape(r)},H=l===n.CHANGE_EMAIL||l===n.CHANGE_PASSWORD;let re={firstName:"",lastName:"",email:"",currentPassword:"",newPassword:"",confirmNewPassword:""};const $=()=>{t.logout().then(()=>{v(J.login)}).catch(s=>{v(J.login)})},u=ae({resolver:ee(W(l)),defaultValues:re}),{watch:ie,setError:M,reset:g,handleSubmit:ne}=u,V=ie("email");c.useEffect(()=>{V!==i.email?(g({...u.getValues(),firstName:i.firstName,lastName:i.lastName}),S(!0)):S(!1)},[V,i.email,g,u]),c.useEffect(()=>{x.getUser({userId:_}).then(s=>{const r={firstName:s.firstName,lastName:s.lastName,email:s.email};b(s),g(r)})},[g,_]),c.useEffect(()=>{const s=W(l);u.reset({...u.getValues()},{errors:!0,schema:s})},[l,u]);const U=ne(async s=>{const{firstName:r,lastName:h,email:y,newPassword:B,currentPassword:Z}=s,m={};i.firstName!==r&&(m.firstName=r),i.lastName!==h&&(m.lastName=h),i.email!==y&&(m.email=y),Z!==""&&(m.password=Z),B!==""&&(m.newPassword=B),z(K(!0)),x.updateUserProfile(m).then(()=>{m.email&&m.email!==i.email?w(!0):H?$():G(!0)}).catch(L=>{L.name==Q.DUPLICATE_EMAIL.name?M("email",{type:"manual",message:a("processed_errors.".concat(L.name))}):L.name==Q.WRONG_CREDENTIALS.name&&M("currentPassword",{type:"manual",message:a("error.incorrect_password")})}).finally(()=>{z(K(!1))})}),te=s=>{w(!1),s&&(E(!0),setTimeout(()=>{$()},300)),C(n.NONE),x.getUser({userId:_}).then(r=>{const h={firstName:r.firstName,lastName:r.lastName,email:r.email};b(r),g(h)})};return e.jsxs(ge,{children:[k&&e.jsx(je,{success:"updated",left:"56"}),e.jsxs(se,{methods:u,onSubmit:U,children:[e.jsx(f,{variant:"h5",sx:{mb:3},children:"Personal"}),e.jsxs(X,{rowGap:2.5,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",md:"repeat(2, 1fr)"},children:[e.jsx(p,{disabled:A,name:"firstName",label:a("label.first_name")}),e.jsx(p,{disabled:A,name:"lastName",label:a("label.last_name")}),e.jsx(p,{disabled:l!=n.CHANGE_EMAIL,name:"email",label:a("label.email")})]}),e.jsx(O,{spacing:3,sx:{my:5},children:e.jsxs(e.Fragment,{children:[l==n.CHANGE_PASSWORD&&e.jsxs("div",{children:[e.jsx(f,{variant:"h5",children:a("profile.change_password")}),e.jsx(f,{variant:"body2",sx:{color:"error.main",mb:1},children:a("profile.hint")})]}),l==n.CHANGE_EMAIL&&e.jsx(f,{variant:"body2",sx:{color:"error.main"},children:a("profile.hint")}),e.jsxs(O,{spacing:2.5,children:[H&&e.jsx(p,{name:"currentPassword",label:a("label.password"),type:o.value?"text":"password",InputProps:{endAdornment:e.jsx(D,{position:"end",children:e.jsx(q,{onClick:o.onToggle,edge:"end",children:e.jsx(P,{icon:o.value?"carbon:view":"carbon:view-off"})})})}}),l==n.CHANGE_PASSWORD&&e.jsxs(e.Fragment,{children:[e.jsx(p,{name:"newPassword",label:a("label.new_password"),type:o.value?"text":"password",InputProps:{endAdornment:e.jsx(D,{position:"end",children:e.jsx(q,{onClick:o.onToggle,edge:"end",children:e.jsx(P,{icon:o.value?"carbon:view":"carbon:view-off"})})})}}),e.jsx(p,{name:"confirmNewPassword",label:a("label.confirm_new_password"),type:o.value?"text":"password",InputProps:{endAdornment:e.jsx(D,{position:"end",children:e.jsx(q,{onClick:o.onToggle,edge:"end",children:e.jsx(P,{icon:o.value?"carbon:view":"carbon:view-off"})})})}})]})]})]})}),e.jsxs(O,{spacing:1,direction:"row",children:[l==n.NONE&&e.jsx(N,{color:"inherit",size:"large",variant:"contained",onClick:()=>C(n.CHANGE_EMAIL),children:a("profile.change_email")}),l==n.NONE&&e.jsx(N,{color:"inherit",size:"large",variant:"contained",onClick:()=>C(n.CHANGE_PASSWORD),children:a("profile.change_password")}),H&&e.jsx(N,{color:"inherit",size:"large",variant:"contained",onClick:()=>C(n.NONE),children:a("profile.cancel")}),e.jsx(N,{color:"inherit",size:"large",type:"submit",variant:"contained",loading:I,children:a("profile.save")})]})]}),e.jsx(Ee,{t:a,open:j,email:i==null?void 0:i.email,resend:U,onClose:te}),e.jsx(me,{open:R,autoHideDuration:6e3,onClose:F,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(ue,{onClose:F,severity:"success",variant:"filled",sx:{width:"100%"},children:a("email.email_changed")})})]})}export{Me as default};
